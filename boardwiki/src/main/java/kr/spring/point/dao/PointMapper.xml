<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="kr.spring.point.dao.PointMapper"> 
	<!-- 조건에 따른 총 포인트 증/감 -->
	  <update id="updatepointtotal" parameterType="pointVO">
	  <![CDATA[
        UPDATE point_total 
        SET point_total = 
        CASE 
            WHEN #{poi_increase} = 1 THEN point_total - #{poi_use}
            WHEN #{poi_increase} = 2 THEN point_total + #{poi_use}
            ELSE point_total 
        END 
        WHERE mem_num = #{mem_num} 
        AND (#{poi_increase} != 1 OR point_total >= #{poi_use})
        ]]>
    </update>
    <!-- include을 이용한 SQL문 재사용 -->
    <sql id="pointstatus">
            <if test="poi_status != null and poi_status != ''">
                AND poi_status = #{poi_status}
            </if>
    </sql>

    <!-- 포인트 내역 수 -->
    <select id="selectRowCount" parameterType="map" resultType="integer">
    <![CDATA[
        SELECT COUNT(*) 
        FROM point 
        JOIN point_total USING(mem_num) 
        WHERE mem_num = #{mem_num} 
    ]]>
        <include refid="pointstatus"/>
    </select>

    <!-- 포인트 목록 내역 -->
    <select id="selectPointList" parameterType="map" resultType="pointVO">
        SELECT * 
        FROM (
            SELECT a.*, rownum rnum 
            FROM (
                SELECT * 
                FROM point 
                JOIN point_total USING(mem_num)
                WHERE mem_num = #{mem_num} 
        		<include refid="pointstatus"/>
            ) a
        )
    <![CDATA[
       WHERE rnum >= #{start} AND rnum <= #{end}
    ]]>
    </select>
 </mapper>