<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="kr.spring.team.dao.TeamMapper"> 
	<!-- sql 태그와 include 태그를 이용해서 SQL문을 재사용 -->
	 <sql id="teamSearch">
	 	<where>
	 		<if test="keyword !=null and keyword != ''">
		 		<if test="keyfield == 1">
		 			tea_name LIKE '%' || #{keyword} || '%'
		 		</if>
		 		<if test="keyfield == 2">
		 			tea_address1 LIKE '%' || #{keyword} || '%'
		 		</if>
	 		</if>
	 	</where>
	 </sql>
	 <sql id="teamOrder">
	 	<if test="order == 1">
	 		ORDER BY tea_num DESC
	 	</if>
	 	<if test="order == 2">
	 		ORDER BY tea_hit DESC
	 	</if>
	 	<if test="order == 3">
	 		ORDER BY fav_cnt DESC NULLS LAST
	 	</if>
	 </sql>
	  <!-- 모임 등록 -->
	  <insert id="insertTeam" parameterType="teamVO" >
	  	INSERT INTO team(
	  	tea_num,
	  	tea_name,
	  	tea_content,
	  	tea_time,
	  	tea_zipcode,
	  	tea_address1,
	  	tea_address2,
	  	tea_man,
	  	mem_num
	  	)
	   VALUES(
	   #{tea_num},
	   #{tea_name},
	   #{tea_content},
	   #{tea_time, jdbcType=VARCHAR},
	   #{tea_zipcode},
	   #{tea_address1},
	   #{tea_address2},
	   #{tea_man},
	   #{mem_num}
	   )
	  </insert>
	 <!-- 모임 목록 -->
	 <select id="getTeamRowCount" parameterType="map" resultType="integer">
	 	SELECT count(*)FROM team JOIN member USING(mem_num) WHERE tea_status = 1
	 </select>
	 <select id="selectTeamList" parameterType="map" resultType="teamVO">
	 	SELECT *FROM
	 	(SELECT a.*, rownum rnum FROM
	 	(SELECT tea_num,
	 	  <![CDATA[
	         REPLACE(REPLACE(tea_name,'<','&lt;'),'>','&gt;') tea_name,
	      ]]>
	      tea_content,
	      tea_time,
	      tea_zipcode,
	      tea_address1,
	      tea_address2,
	      tea_rdate,
	      tea_man,
	      tea_hit,
	      tea_status,
	      mem_num,
	      mem_email,
	      fav_cnt
	      FROM team
	      JOIN member USING (mem_num) 
	      LEFT OUTER JOIN (SELECT count(*) fav_cnt ,tea_num FROM team_fav GROUP BY tea_num) USING(tea_num)
	      <include refid="teamSearch"></include>
	      <include refid="teamOrder"></include>	
	 	)a)
	 	<![CDATA[
	 	WHERE rnum >= #{start} AND rnum <= #{end} AND tea_status = 1
	 	]]>	
	 </select>
	 <!-- 모임 수정 -->
	 <update id="updateTeam" parameterType="teamVO" >
	  UPDATE
	   team
	   SET
	   tea_name=#{tea_name},
	   tea_content=#{tea_content},
	   tea_time=#{tea_time, jdbcType=VARCHAR},
	   tea_zipcode=#{tea_zipcode},
	   tea_address1=#{tea_address1},
	   tea_address2=#{tea_address2},
	   tea_man=#{tea_man}
	   WHERE tea_num =#{tea_num}
	 </update>
	 <!-- 일정 등록 -->
	 
	 
	 
	 <!--모임 등록시 관리자 설정 -->
	 <insert id="insertTeamApplyByAdmin" parameterType="teamApplyVO">
	 	INSERT INTO
	 	team_apply(
	 	 teaA_num,
	 	 tea_num,
	 	 teaA_auth,
	 	 teaA_status,
	 	 mem_num
	 	)
	 	VALUES(
	 	team_apply_seq.nextval,
	 	#{tea_num},
	 	9,
	 	1,
	 	#{mem_num}
	 	)
	 	
	 </insert>
	 	 <insert id="insertTeamApply" parameterType="teamApplyVO">
	 	INSERT INTO
	 	team_apply(
	 	 teaA_num,
	 	 teaA_content,
	 	 tea_num,
	 	 mem_num
	 	)
	 	VALUES(
	 	team_apply_seq.nextval,
	 	#{teaA_content , jdbcType=VARCHAR},
	 	#{tea_num},
	 	#{mem_num}
	 	)
	 </insert>
 </mapper>







